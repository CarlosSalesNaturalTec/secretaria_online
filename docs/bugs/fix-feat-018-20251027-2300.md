# Fix Report: feat-018 - Criar AuthService com l√≥gica de autentica√ß√£o

**Data do Ajuste:** 2025-10-27 23:00
**Tipo:** üêõ Bug Cr√≠tico

---

## 1. PROBLEMA ORIGINAL

### Descri√ß√£o do Problema
Ao tentar alterar a senha de um usu√°rio atrav√©s da rota `auth/change-password`, a API retorna um erro 500. A causa √© um erro `Illegal arguments: string, undefined` lan√ßado pela biblioteca `bcryptjs`.

### Contexto
- **Reportado por:** Desenvolvedor (via log de erro)
- **Ambiente:** Desenvolvimento
- **Impacto:** Cr√≠tico (funcionalidade principal de seguran√ßa inutiliz√°vel)

### Comportamento Esperado
O usu√°rio deve conseguir alterar sua senha fornecendo a senha antiga e a nova senha corretamente. A API deve retornar uma resposta de sucesso.

### Comportamento Observado
A API falha com um erro interno, impedindo a altera√ß√£o da senha. O log de erro exibe: `[AuthController] Erro ao alterar senha: Error: Illegal arguments: string, undefined`.

---

## 2. AN√ÅLISE DA CAUSA RAIZ

### Investiga√ß√£o
A an√°lise do stack trace apontou para a fun√ß√£o `AuthService.changePassword` no arquivo `backend/src/services/auth.service.js`. A linha do erro era `await bcrypt.compare(oldPassword, user.password_hash)`. O erro `Illegal arguments` indica que um dos par√¢metros era `undefined`.

### Causa Identificada
A consulta ao banco de dados para buscar o usu√°rio (`await User.findByPk(userId)`) n√£o estava incluindo o campo `password_hash`. O modelo `User` possui um `defaultScope` que exclui o hash da senha por padr√£o por raz√µes de seguran√ßa. Consequentemente, `user.password_hash` era `undefined`, causando o erro na fun√ß√£o `bcrypt.compare`.

### Arquivos/Componentes Afetados
- `backend/src/services/auth.service.js` - L√≥gica de neg√≥cio para altera√ß√£o de senha.

---

## 3. SOLU√á√ÉO IMPLEMENTADA

### Estrat√©gia de Corre√ß√£o
A corre√ß√£o consiste em utilizar o escopo (`scope`) j√° existente no modelo `User` chamado `withPassword`. Este escopo foi projetado especificamente para incluir o campo `password_hash` em consultas onde a verifica√ß√£o de senha √© necess√°ria, como no login e na altera√ß√£o de senha.

### Mudan√ßas Realizadas

#### Backend
- Em `backend/src/services/auth.service.js`, a consulta ao usu√°rio na fun√ß√£o `changePassword` foi modificada para incluir o escopo `withPassword`.

---

## 4. ARQUIVOS MODIFICADOS

### auth.service.js
**Caminho:** `backend/src/services/auth.service.js`

**Mudan√ßas:**
- ‚úÖ Adicionado o escopo `'withPassword'` √† consulta do usu√°rio para garantir que o `password_hash` seja retornado do banco de dados.

**C√≥digo Relevante:**
```javascript
// ...
  async changePassword(userId, oldPassword, newPassword) {
    const user = await User.scope('withPassword').findByPk(userId);

    if (!user) {
      throw new Error('Usu√°rio n√£o encontrado');
    }
// ...
```

---

**Ajuste conclu√≠do em:** 2025-10-27 23:00
**Revisado por:** Gemini
