# Fix Report: feat-019 - Falha na Autentica√ß√£o de Usu√°rio

**Data do Ajuste:** 2025-10-27 22:00
**Tipo:** üêõ Bug Cr√≠tico

---

## 1. PROBLEMA ORIGINAL

### Descri√ß√£o do Problema
O sistema estava apresentando uma falha cr√≠tica durante a tentativa de login. Qualquer tentativa de autentica√ß√£o resultava em um erro interno no servidor (`HTTP 500`), impedindo completamente o acesso de qualquer usu√°rio.

### Contexto
- **Reportado por:** Desenvolvedor (durante teste local)
- **Ambiente:** Desenvolvimento
- **Impacto:** Cr√≠tico - A funcionalidade principal de login estava inoperante.

### Comportamento Esperado
O usu√°rio deveria conseguir fazer login fornecendo credenciais v√°lidas (login e senha), recebendo um token de autentica√ß√£o como resposta.

### Comportamento Observado
O servidor retornava um erro e o log da aplica√ß√£o exibia a seguinte mensagem:
`[AuthController] Erro ao fazer login: Error: Illegal arguments: string, undefined`
Este erro se originava na biblioteca `bcryptjs` durante a compara√ß√£o de senhas.

---

## 2. AN√ÅLISE DA CAUSA RAIZ

### Investiga√ß√£o
A an√°lise do stack trace indicou que a fun√ß√£o `bcrypt.compare(password, user.password_hash)` estava sendo chamada com `user.password_hash` sendo `undefined`. Isso significava que o objeto `user`, recuperado do banco de dados, n√£o continha o hash da senha.

A investiga√ß√£o foi direcionada ao modelo `User` do Sequelize.

### Causa Identificada
A causa raiz foi identificada no arquivo `backend/src/models/User.js`. O modelo `User` utiliza um `defaultScope` que, por padr√£o e como medida de seguran√ßa, exclui o campo `password_hash` de todas as consultas.

```javascript
// backend/src/models/User.js
defaultScope: {
  attributes: {
    exclude: ['password_hash'],
  },
},
```

A consulta no `AuthService` (`User.findOne({ where: { login } })`) n√£o estava utilizando o `scope` necess√°rio para incluir este campo, resultando em `user.password_hash` sendo `undefined`.

### Arquivos/Componentes Afetados
- `backend/src/services/auth.service.js` - Respons√°vel pela l√≥gica de login e consulta do usu√°rio.
- `backend/src/models/User.js` - Onde a exclus√£o do campo `password_hash` √© definida.

---

## 3. SOLU√á√ÉO IMPLEMENTADA

### Estrat√©gia de Corre√ß√£o
A estrat√©gia foi utilizar o `scope` `"withPassword"`, j√° existente no modelo `User`, que foi projetado especificamente para incluir o campo `password_hash` em consultas de autentica√ß√£o.

### Mudan√ßas Realizadas

#### Backend
A √∫nica mudan√ßa necess√°ria foi na consulta ao banco de dados dentro do m√©todo `login` do `AuthService`.

---

## 4. ARQUIVOS MODIFICADOS

### auth.service.js
**Caminho:** `backend/src/services/auth.service.js`

**Mudan√ßas:**
- ‚úÖ Adicionado `.scope('withPassword')` √† consulta `User.findOne` para garantir que o `password_hash` seja retornado do banco de dados.

**C√≥digo Relevante:**
```javascript
// ANTES
const user = await User.findOne({ where: { login } });

// DEPOIS
const user = await User.scope('withPassword').findOne({ where: { login } });
```

---

**Ajuste conclu√≠do em:** 2025-10-27 22:00
**Revisado por:** Gemini
