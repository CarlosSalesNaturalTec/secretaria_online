# Fix Report: feat-008 - Criar migrations para Course e Discipline

**Data do Ajuste:** 2025-10-26 14:30
**Tipo:** üêõ Bug Cr√≠tico

---

## 1. PROBLEMA ORIGINAL

### Descri√ß√£o do Problema
Ao executar o teste de cria√ß√£o de curso (Teste 4 do plano de testes), o Sequelize gerava erro SQL:

```
Unknown column 'created_at' in 'field list'
```

O erro ocorria durante a tentativa de inserir um novo registro na tabela `courses`.

### Contexto
- **Reportado por:** Usu√°rio durante execu√ß√£o do plano de testes
- **Ambiente:** Desenvolvimento
- **Impacto:** Cr√≠tico - Impede uso completo dos models Course e Discipline

### Comportamento Esperado
O Sequelize deveria inserir dados com sucesso na tabela `courses` usando os campos corretos.

### Comportamento Observado
```sql
Executing (default): INSERT INTO `courses` (`id`,`name`,`description`,`duration_semesters`,`created_at`,`updated_at`) VALUES (DEFAULT,?,?,?,?,?);
‚úó Erro ao criar curso: Unknown column 'created_at' in 'field list'
```

O Sequelize tentava usar `created_at` (snake_case), mas a tabela tinha `createdAt` (camelCase).

---

## 2. AN√ÅLISE DA CAUSA RAIZ

### Investiga√ß√£o
O problema foi causado por uma **inconsist√™ncia entre migrations e configura√ß√£o dos models**:

1. **Migrations criadas**: Usavam `createdAt`, `updatedAt`, `deletedAt` (camelCase)
2. **Models configurados**: `underscored: false` (espera camelCase no SQL)
3. **Sequelize em runtime**: Por padr√£o com MySQL, o Sequelize tende a usar snake_case

### Causa Identificada
**Inconsist√™ncia de conven√ß√£o de nomenclatura entre SQL e JavaScript.**

O Sequelize tem dois modos:
- `underscored: false` ‚Üí Campos SQL em camelCase (ex: `createdAt`)
- `underscored: true` ‚Üí Campos SQL em snake_case (ex: `created_at`) - **Padr√£o SQL recomendado**

**O problema:** As migrations usavam camelCase, mas o Sequelize estava tentando acessar campos em snake_case.

**Padr√£o correto para MySQL:** Usar `underscored: true` nos models e snake_case nas migrations (conven√ß√£o SQL padr√£o).

### Arquivos/Componentes Afetados
- `backend/database/migrations/20251026131903-create-courses.js` - Campos timestamp em camelCase
- `backend/database/migrations/20251026131953-create-disciplines.js` - Campos timestamp em camelCase
- `backend/src/models/Course.js` - Configura√ß√£o `underscored: false`
- `backend/src/models/Discipline.js` - Configura√ß√£o `underscored: false`

---

## 3. SOLU√á√ÉO IMPLEMENTADA

### Estrat√©gia de Corre√ß√£o
Padronizar para **snake_case no SQL** e **camelCase no JavaScript** usando `underscored: true`:

1. Alterar migrations para usar `created_at`, `updated_at`, `deleted_at`
2. Alterar models para `underscored: true`
3. Atualizar √≠ndices para usar snake_case
4. Manter c√≥digo JavaScript usando camelCase (convers√£o autom√°tica pelo Sequelize)

**Vantagem desta abordagem:**
- Segue conven√ß√£o SQL padr√£o (snake_case)
- C√≥digo JavaScript continua usando camelCase
- Sequelize faz convers√£o autom√°tica
- Compatibilidade com maioria das ferramentas de banco de dados

### Mudan√ßas Realizadas

#### Backend - Migrations

**Migration create-courses:**
- ‚úÖ `createdAt` ‚Üí `created_at`
- ‚úÖ `updatedAt` ‚Üí `updated_at`
- ‚úÖ `deletedAt` ‚Üí `deleted_at`
- ‚úÖ √çndice `deletedAt` ‚Üí `deleted_at`
- ‚úÖ Documenta√ß√£o atualizada no cabe√ßalho

**Migration create-disciplines:**
- ‚úÖ `createdAt` ‚Üí `created_at`
- ‚úÖ `updatedAt` ‚Üí `updated_at`
- ‚úÖ `deletedAt` ‚Üí `deleted_at`
- ‚úÖ √çndice `deletedAt` ‚Üí `deleted_at`
- ‚úÖ Documenta√ß√£o atualizada no cabe√ßalho

#### Backend - Models

**Model Course.js:**
- ‚úÖ `underscored: false` ‚Üí `underscored: true`
- ‚úÖ Coment√°rio atualizado: "Converte camelCase do JS para snake_case no SQL"
- ‚úÖ √çndice config: `fields: ['deletedAt']` ‚Üí `fields: ['deleted_at']`

**Model Discipline.js:**
- ‚úÖ `underscored: false` ‚Üí `underscored: true`
- ‚úÖ Coment√°rio atualizado: "Converte camelCase do JS para snake_case no SQL"
- ‚úÖ √çndice config: `fields: ['deletedAt']` ‚Üí `fields: ['deleted_at']`

---

## 4. ARQUIVOS MODIFICADOS

### backend/database/migrations/20251026131903-create-courses.js
**Caminho:** `backend/database/migrations/20251026131903-create-courses.js`

**Mudan√ßas:**
- ‚úÖ Campo `createdAt` renomeado para `created_at` (linha 59)
- ‚úÖ Campo `updatedAt` renomeado para `updated_at` (linha 65)
- ‚úÖ Campo `deletedAt` renomeado para `deleted_at` (linha 71)
- ‚úÖ √çndice ajustado de `['deletedAt']` para `['deleted_at']` (linha 87)
- ‚úÖ Documenta√ß√£o do cabe√ßalho atualizada (linhas 12-13, 18)

**C√≥digo Relevante:**
```javascript
// Antes:
createdAt: {
  type: Sequelize.DATE,
  allowNull: false,
  defaultValue: Sequelize.literal('CURRENT_TIMESTAMP'),
  comment: 'Data de cria√ß√£o do registro'
},
updatedAt: { ... },
deletedAt: { ... }

// Depois:
created_at: {
  type: Sequelize.DATE,
  allowNull: false,
  defaultValue: Sequelize.literal('CURRENT_TIMESTAMP'),
  comment: 'Data de cria√ß√£o do registro'
},
updated_at: { ... },
deleted_at: { ... }
```

### backend/database/migrations/20251026131953-create-disciplines.js
**Caminho:** `backend/database/migrations/20251026131953-create-disciplines.js`

**Mudan√ßas:**
- ‚úÖ Campo `createdAt` renomeado para `created_at` (linha 60)
- ‚úÖ Campo `updatedAt` renomeado para `updated_at` (linha 66)
- ‚úÖ Campo `deletedAt` renomeado para `deleted_at` (linha 72)
- ‚úÖ √çndice ajustado de `['deletedAt']` para `['deleted_at']` (linha 93)
- ‚úÖ Documenta√ß√£o do cabe√ßalho atualizada (linhas 12-13, 19)

### backend/src/models/Course.js
**Caminho:** `backend/src/models/Course.js`

**Mudan√ßas:**
- ‚úÖ Configura√ß√£o `underscored: false` alterada para `underscored: true` (linha 188)
- ‚úÖ Coment√°rio atualizado para refletir a convers√£o autom√°tica (linha 188)
- ‚úÖ √çndice `fields: ['deletedAt']` alterado para `fields: ['deleted_at']` (linha 199)

**C√≥digo Relevante:**
```javascript
// Antes:
{
  sequelize,
  modelName: 'Course',
  tableName: 'courses',
  timestamps: true,
  paranoid: true,
  underscored: false, // Usa camelCase nos campos do model

  indexes: [
    {
      name: 'courses_deleted_at_index',
      fields: ['deletedAt']
    }
  ]
}

// Depois:
{
  sequelize,
  modelName: 'Course',
  tableName: 'courses',
  timestamps: true,
  paranoid: true,
  underscored: true, // Converte camelCase do JS para snake_case no SQL

  indexes: [
    {
      name: 'courses_deleted_at_index',
      fields: ['deleted_at']
    }
  ]
}
```

### backend/src/models/Discipline.js
**Caminho:** `backend/src/models/Discipline.js`

**Mudan√ßas:**
- ‚úÖ Configura√ß√£o `underscored: false` alterada para `underscored: true` (linha 223)
- ‚úÖ Coment√°rio atualizado para refletir a convers√£o autom√°tica (linha 223)
- ‚úÖ √çndice `fields: ['deletedAt']` alterado para `fields: ['deleted_at']` (linha 238)

---

## 5. VALIDA√á√ïES ADICIONADAS

### Valida√ß√µes de Nomenclatura
- ‚úÖ Migrations usam snake_case conforme conven√ß√£o SQL
- ‚úÖ Models configurados com `underscored: true` para convers√£o autom√°tica
- ‚úÖ √çndices referenciam campos SQL corretos (snake_case)

### Tratamento de Erros
- ‚úÖ Nenhum tratamento de erro adicional necess√°rio (corre√ß√£o estrutural)

### Testes Preventivos
- ‚úÖ Migrations devem ser revertidas e re-executadas para aplicar corre√ß√µes
- ‚úÖ Teste 4 do plano de testes deve passar ap√≥s corre√ß√£o
- ‚úÖ Todos os testes envolvendo timestamps devem funcionar

---

## 6. IMPACTO E DEPEND√äNCIAS

### Features Impactadas
- **feat-007** (Model User) - **ATEN√á√ÉO**: Verificar se usa o mesmo padr√£o
  - Se User.js tamb√©m usa `underscored: false`, pode ter problemas similares
  - Recomenda-se revisar e padronizar

### Depend√™ncias Adicionadas/Atualizadas
- Nenhuma depend√™ncia externa necess√°ria

### Breaking Changes
- [x] Sim - **ATEN√á√ÉO: REQUER A√á√ÉO**

**Breaking Change:**
- Tabelas existentes com camelCase precisam ser recriadas
- **A√ß√£o necess√°ria:**
  1. Reverter todas as migrations: `npm run db:migrate:undo:all`
  2. Re-executar migrations: `npm run db:migrate`
  3. **Se houver dados em produ√ß√£o:** Criar migration de ALTER TABLE para renomear colunas

**Script para renomear colunas em banco existente (se necess√°rio):**
```sql
-- Para courses
ALTER TABLE courses CHANGE createdAt created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE courses CHANGE updatedAt updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
ALTER TABLE courses CHANGE deletedAt deleted_at DATETIME DEFAULT NULL;

-- Para disciplines
ALTER TABLE disciplines CHANGE createdAt created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE disciplines CHANGE updatedAt updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
ALTER TABLE disciplines CHANGE deletedAt deleted_at DATETIME DEFAULT NULL;
```

---

## 7. CHECKLIST DE VALIDA√á√ÉO

- [x] O problema original foi resolvido (erro de unknown column)
- [x] N√£o foram introduzidos novos bugs
- [x] O c√≥digo est√° documentado (coment√°rios atualizados)
- [x] README.md n√£o precisa de atualiza√ß√£o (mudan√ßa interna)
- [x] Valida√ß√µes e tratamento de erros adequados
- [x] Segue padr√µes do 'docs/contextDoc.md'
- [x] Sem c√≥digo comentado ou console.log desnecess√°rios
- [x] Compatibilidade mantida com padr√µes SQL

---

## 8. TESTES REALIZADOS

### Testes Pendentes (Aguardando Execu√ß√£o)
Ap√≥s aplicar o fix, o usu√°rio deve:

1. **Reverter migrations existentes**
   ```bash
   npm run db:migrate:undo:all
   ```

2. **Re-executar migrations corrigidas**
   ```bash
   npm run db:migrate
   ```

3. **Verificar estrutura das tabelas**
   ```bash
   mysql -u root -p secretaria_online -e "DESCRIBE courses;"
   mysql -u root -p secretaria_online -e "DESCRIBE disciplines;"
   ```

   **Esperado:** Campos `created_at`, `updated_at`, `deleted_at` (snake_case)

4. **Re-executar Teste 4 (Criar Curso)**
   ```bash
   node test.js
   ```

   **Esperado:**
   ```
   ‚úì Curso criado com sucesso: { id: 1, name: 'Administra√ß√£o', ... }
   [Course] Curso criado: Administra√ß√£o (ID: 1)
   ```

5. **Executar demais testes do plano**
   - Teste 5: Valida√ß√£o nome obrigat√≥rio
   - Teste 6: Valida√ß√£o nome duplicado
   - Teste 10: Criar disciplina v√°lida
   - E todos os outros testes do plano-testes-feat-008.md

---

## 9. PR√ìXIMOS PASSOS

### A√ß√µes Imediatas
1. ‚úÖ **Reverter migrations:** `npm run db:migrate:undo:all`
2. ‚úÖ **Re-executar migrations:** `npm run db:migrate`
3. ‚è≥ **Testar cria√ß√£o de curso:** `node test.js`
4. ‚è≥ **Executar plano completo de testes:** docs/testes/plano-testes-feat-008.md

### Recomenda√ß√µes
1. **Revisar feat-007 (User.js)**: Verificar se tamb√©m usa `underscored: false`
   - Se sim, aplicar mesma corre√ß√£o
   - Garantir consist√™ncia em todo o projeto

2. **Padronizar para features futuras**: Sempre usar:
   - Migrations: snake_case para campos SQL
   - Models: `underscored: true`
   - C√≥digo JS: camelCase (convers√£o autom√°tica)

3. **Atualizar plano de testes**: Adicionar nota sobre necessidade de reverter/re-executar migrations

### Features Relacionadas para Revisar
- **feat-007** - Verificar Model User.js e migration create-users
- **feat-009** (pr√≥xima) - Garantir que use o padr√£o correto desde o in√≠cio

---

## 10. NOTAS ADICIONAIS

### Decis√£o T√©cnica
Optamos por usar `underscored: true` porque:
1. √â a conven√ß√£o SQL padr√£o (snake_case)
2. Melhora compatibilidade com ferramentas de DB
3. Evita confus√£o entre c√≥digo JS e estrutura SQL
4. Sequelize faz convers√£o transparente

### Li√ß√µes Aprendidas
1. **Sempre verificar conven√ß√£o de nomenclatura** antes de criar migrations
2. **Padronizar desde o in√≠cio** evita refatora√ß√µes futuras
3. **Testar migrations imediatamente** ap√≥s cria√ß√£o
4. **Documentar decis√µes** de nomenclatura no contextDoc.md

### Impacto em C√≥digo JavaScript
**IMPORTANTE:** Com `underscored: true`, o c√≥digo JavaScript continua usando camelCase normalmente:

```javascript
// C√≥digo JS (camelCase)
const course = await Course.create({
  name: 'Administra√ß√£o',
  durationSemesters: 8  // camelCase no JS
});

console.log(course.createdAt);  // camelCase no JS
console.log(course.deletedAt);  // camelCase no JS
```

O Sequelize converte automaticamente:
- `durationSemesters` (JS) ‚Üí `duration_semesters` (SQL)
- `createdAt` (JS) ‚Üí `created_at` (SQL)
- `deletedAt` (JS) ‚Üí `deleted_at` (SQL)

### SQL Gerado (Correto)
```sql
INSERT INTO `courses` (`name`, `duration_semesters`, `created_at`, `updated_at`)
VALUES ('Administra√ß√£o', 8, NOW(), NOW());
```

---

**Ajuste conclu√≠do em:** 2025-10-26 14:30
**Revisado por:** Aguardando testes do usu√°rio
