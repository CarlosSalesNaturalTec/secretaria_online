# Fix Report: feat-008 - Criar migrations para Course e Discipline

**Data do Ajuste:** 2025-10-26 14:48
**Tipo:** üêõ Bug Cr√≠tico

---

## 1. PROBLEMA ORIGINAL

### Descri√ß√£o do Problema
Ao executar o teste de cria√ß√£o de curso (`node test.js`), o Sequelize retornava o erro:
```
Unknown column 'created_at' in 'field list'
```

Isso impedia completamente a cria√ß√£o de registros nas tabelas `courses` e `disciplines`, tornando os models inutiliz√°veis.

### Contexto
- **Reportado por:** Desenvolvedor (via teste local)
- **Ambiente:** Desenvolvimento
- **Impacto:** Cr√≠tico - Funcionalidade completamente bloqueada

### Comportamento Esperado
O Sequelize deveria inserir registros na tabela `courses` utilizando as colunas `created_at`, `updated_at` e `deleted_at` (snake_case), conforme definido nas migrations e configura√ß√£o do projeto.

### Comportamento Observado
O Sequelize tentava inserir dados nas colunas `created_at`, `updated_at` e `deleted_at`, mas o MySQL retornava erro informando que essas colunas n√£o existiam.

Ao investigar a estrutura real da tabela no banco de dados, descobriu-se que as colunas foram criadas como `createdAt`, `updatedAt` e `deletedAt` (camelCase), contrariando a defini√ß√£o das migrations.

---

## 2. AN√ÅLISE DA CAUSA RAIZ

### Investiga√ß√£o
1. Verifica√ß√£o do status das migrations - confirmou que as migrations foram executadas (`up`)
2. An√°lise da estrutura real da tabela usando `DESCRIBE courses` - revelou que as colunas estavam em camelCase
3. Compara√ß√£o com a migration de `users` que funcionava corretamente - confirmou que o padr√£o snake_case estava correto
4. An√°lise da configura√ß√£o do Sequelize em `src/config/database.js` - confirmou `underscored: true`

### Causa Identificada
**Inconsist√™ncia entre execu√ß√£o das migrations:**

As migrations foram executadas anteriormente de forma que criou as tabelas com nomenclatura camelCase (`createdAt`, `updatedAt`, `deletedAt`), mesmo tendo sido definidas como snake_case (`created_at`, `updated_at`, `deleted_at`) no c√≥digo da migration.

**Por que o erro ocorreu:**
1. A configura√ß√£o do projeto usa `underscored: true` (linha 81 de `src/config/database.js`)
2. Os models estavam corretamente configurados com `underscored: true`
3. Com essa configura√ß√£o, o Sequelize converte automaticamente camelCase ‚Üí snake_case ao gerar SQL
4. O Sequelize tentava inserir em `created_at`, mas o banco tinha apenas `createdAt`
5. Resultado: **Unknown column 'created_at'**

**Hip√≥tese sobre a causa inicial:**
Provavelmente as migrations foram executadas em um momento em que:
- Havia uma configura√ß√£o diferente do Sequelize CLI
- Ou as tabelas foram criadas manualmente antes
- Ou houve alguma execu√ß√£o parcial que n√£o respeitou a defini√ß√£o da migration

### Arquivos/Componentes Afetados
- `backend/database/migrations/20251026131903-create-courses.js` - Migration executada incorretamente
- `backend/database/migrations/20251026131953-create-disciplines.js` - Migration executada incorretamente
- `backend/src/models/Course.js` - Configurado corretamente, mas incompat√≠vel com o banco
- `backend/src/models/Discipline.js` - Configurado corretamente, mas incompat√≠vel com o banco
- Tabela `courses` no MySQL - Estrutura incorreta (camelCase)
- Tabela `disciplines` no MySQL - Estrutura incorreta (camelCase)

---

## 3. SOLU√á√ÉO IMPLEMENTADA

### Estrat√©gia de Corre√ß√£o
**Rollback e Re-execu√ß√£o das Migrations:**

A solu√ß√£o adotada foi fazer rollback (reverter) as migrations problem√°ticas e re-execut√°-las corretamente para garantir que as tabelas sejam criadas exatamente conforme definido nas migrations.

### Mudan√ßas Realizadas

#### Backend
**Nenhuma altera√ß√£o de c√≥digo foi necess√°ria.** As migrations e models j√° estavam corretos. O problema era apenas a execu√ß√£o inconsistente das migrations.

#### Banco de Dados

**1. Rollback da migration de disciplines:**
```bash
npx sequelize-cli db:migrate:undo --name 20251026131953-create-disciplines.js
```
- Tabela `disciplines` foi removida (DROP TABLE)
- Registro removido de `SequelizeMeta`

**2. Rollback da migration de courses:**
```bash
npx sequelize-cli db:migrate:undo --name 20251026131903-create-courses.js
```
- Tabela `courses` foi removida (DROP TABLE)
- Registro removido de `SequelizeMeta`

**3. Re-execu√ß√£o de todas as migrations pendentes:**
```bash
npx sequelize-cli db:migrate
```
- Migration `20251026131903-create-courses` executada
  - Tabela `courses` criada com colunas em snake_case
  - SQL gerado: `created_at`, `updated_at`, `deleted_at` ‚úì
  - √çndices criados: `courses_name_unique`, `courses_deleted_at_index`

- Migration `20251026131953-create-disciplines` executada
  - Tabela `disciplines` criada com colunas em snake_case
  - SQL gerado: `created_at`, `updated_at`, `deleted_at` ‚úì
  - √çndices criados: `disciplines_code_unique`, `disciplines_name_index`, `disciplines_deleted_at_index`

**4. Verifica√ß√£o da estrutura criada:**
```bash
node -e "sequelize.query('DESCRIBE courses')"
node -e "sequelize.query('DESCRIBE disciplines')"
```
Confirmado que as colunas est√£o em snake_case:
- ‚úì `created_at`
- ‚úì `updated_at`
- ‚úì `deleted_at`

**5. Teste de cria√ß√£o de registro:**
```bash
node test.js
```
‚úì Curso criado com sucesso (ID: 1)

#### Documenta√ß√£o
Nenhuma altera√ß√£o necess√°ria no README ou outros documentos.

---

## 4. ARQUIVOS MODIFICADOS

### NENHUM ARQUIVO DE C√ìDIGO FOI MODIFICADO

Todos os arquivos (migrations, models, configura√ß√µes) j√° estavam corretos. O problema foi resolvido atrav√©s de comandos de banco de dados (rollback e re-execu√ß√£o).

**Arquivos envolvidos (mas n√£o alterados):**

### backend/database/migrations/20251026131903-create-courses.js
**Caminho:** `backend/database/migrations/20251026131903-create-courses.js`

**Status:** ‚úì C√≥digo correto (sem altera√ß√µes necess√°rias)

**Migration re-executada com sucesso:**
- Tabela `courses` criada corretamente
- Colunas em snake_case: `created_at`, `updated_at`, `deleted_at`
- √çndices aplicados corretamente

### backend/database/migrations/20251026131953-create-disciplines.js
**Caminho:** `backend/database/migrations/20251026131953-create-disciplines.js`

**Status:** ‚úì C√≥digo correto (sem altera√ß√µes necess√°rias)

**Migration re-executada com sucesso:**
- Tabela `disciplines` criada corretamente
- Colunas em snake_case: `created_at`, `updated_at`, `deleted_at`
- √çndices aplicados corretamente

### backend/src/models/Course.js
**Caminho:** `backend/src/models/Course.js`

**Status:** ‚úì C√≥digo correto (sem altera√ß√µes necess√°rias)

**Configura√ß√£o validada:**
- `underscored: true` (linha 188)
- `timestamps: true` (linha 186)
- `paranoid: true` (linha 187)

### backend/src/models/Discipline.js
**Caminho:** `backend/src/models/Discipline.js`

**Status:** ‚úì C√≥digo correto (sem altera√ß√µes necess√°rias)

**Configura√ß√£o validada:**
- `underscored: true` (linha 223)
- `timestamps: true` (linha 221)
- `paranoid: true` (linha 222)

---

## 5. VALIDA√á√ïES ADICIONADAS

### Valida√ß√µes de Entrada
Nenhuma valida√ß√£o adicional foi necess√°ria. As valida√ß√µes existentes nos models j√° estavam adequadas.

### Tratamento de Erros
Nenhum tratamento adicional foi necess√°rio. O problema foi estrutural (banco de dados), n√£o de l√≥gica.

### Testes Preventivos

**Procedimento de verifica√ß√£o implementado:**

1. **Verificar status das migrations antes de assumir problema de c√≥digo:**
   ```bash
   npx sequelize-cli db:migrate:status
   ```

2. **Verificar estrutura real das tabelas no banco:**
   ```bash
   node -e "sequelize.query('DESCRIBE table_name')"
   ```

3. **Comparar com migrations que funcionam (ex: users):**
   - Verificar se o padr√£o de nomenclatura est√° consistente

4. **Sempre testar ap√≥s migrations:**
   ```bash
   node test.js
   ```

**Li√ß√£o aprendida:**
- Sempre verificar a estrutura real do banco antes de alterar c√≥digo
- Migrations executadas de forma inconsistente podem causar problemas dif√≠ceis de diagnosticar
- O comando `DESCRIBE table_name` √© essencial para debug de problemas com Sequelize

---

## 6. IMPACTO E DEPEND√äNCIAS

### Features Impactadas
**Nenhuma feature impactada negativamente.**

Esta corre√ß√£o **habilita** a continua√ß√£o do desenvolvimento da feat-008 e features futuras que dependem de `Course` e `Discipline`:
- ‚úì [feat-008] Criar migrations para Course e Discipline - CORRIGIDA
- üîÑ [feat-009] Criar migration para tabela course_disciplines (associa√ß√£o N:N) - DEPENDENTE
- üîÑ [feat-010] Criar migrations para Class e ClassTeacher - DEPENDENTE
- üîÑ [feat-011] Criar migration para Enrollment - DEPENDENTE
- üîÑ [feat-014] Criar migration para Evaluation - DEPENDENTE

### Depend√™ncias Adicionadas/Atualizadas
Nenhuma depend√™ncia foi adicionada ou atualizada.

### Breaking Changes
- [ ] Sim / [x] N√£o

**Observa√ß√£o importante:**
Se houver dados na tabela `courses` ou `disciplines` em ambiente de desenvolvimento, eles foram **perdidos** durante o rollback. Isso √© aceit√°vel em desenvolvimento, mas **NUNCA deve ser feito em produ√ß√£o sem backup**.

---

## 7. CHECKLIST DE VALIDA√á√ÉO

- [x] O problema original foi resolvido
- [x] N√£o foram introduzidos novos bugs
- [x] O c√≥digo est√° documentado (j√° estava)
- [x] README.md est√° atualizado (n√£o necess√°rio)
- [x] Valida√ß√µes e tratamento de erros adequados (j√° estavam)
- [x] Segue padr√µes do 'docs/contextDoc.md'
- [x] Sem c√≥digo comentado ou console.log desnecess√°rios
- [x] Testado localmente
- [x] Compatibilidade mantida
- [x] Migrations executadas com sucesso
- [x] Estrutura das tabelas validada (DESCRIBE)
- [x] Teste de cria√ß√£o de registro passou

---

## 8. TESTES REALIZADOS

### Cen√°rios Testados

1. **Verifica√ß√£o de status das migrations** - ‚úÖ Passou
   ```bash
   npx sequelize-cli db:migrate:status
   ```
   - Resultado: Todas as migrations marcadas como `up`

2. **Verifica√ß√£o da estrutura da tabela courses** - ‚úÖ Passou
   ```bash
   node -e "sequelize.query('DESCRIBE courses')"
   ```
   - Resultado: Colunas em snake_case (`created_at`, `updated_at`, `deleted_at`)

3. **Verifica√ß√£o da estrutura da tabela disciplines** - ‚úÖ Passou
   ```bash
   node -e "sequelize.query('DESCRIBE disciplines')"
   ```
   - Resultado: Colunas em snake_case (`created_at`, `updated_at`, `deleted_at`)

4. **Teste de cria√ß√£o de curso** - ‚úÖ Passou
   ```bash
   node test.js
   ```
   - Resultado:
     ```
     ‚úì Curso criado com sucesso: {
       id: 1,
       name: 'Administra√ß√£o',
       description: 'Curso de Bacharelado em Administra√ß√£o de Empresas',
       duration_semesters: 8,
       updated_at: 2025-10-26T13:48:00.339Z,
       created_at: 2025-10-26T13:48:00.339Z
     }
     ```

### Casos de Borda Validados

- **Curso com nome duplicado**: N√£o testado ainda (ser√° testado no plano de testes completo)
- **Disciplina com c√≥digo duplicado**: N√£o testado ainda (ser√° testado no plano de testes completo)
- **Soft delete (paranoid)**: N√£o testado ainda (ser√° testado no plano de testes completo)

**Nota:** Os testes de valida√ß√µes de modelo e casos de borda est√£o documentados em `docs/testes/plano-testes-feat-008.md` e ser√£o executados ap√≥s a aprova√ß√£o deste fix.

---

## 9. PR√ìXIMOS PASSOS

### Recomenda√ß√µes

1. **Executar o plano de testes completo da feat-008:**
   - Seguir o documento `docs/testes/plano-testes-feat-008.md`
   - Validar todas as valida√ß√µes dos models
   - Testar cen√°rios de erro e casos de borda

2. **Documentar procedimento de debug de migrations:**
   - Adicionar se√ß√£o no README sobre como diagnosticar problemas com migrations
   - Incluir comandos √∫teis (`DESCRIBE`, `db:migrate:status`, etc.)

3. **Considerar script de valida√ß√£o p√≥s-migration:**
   - Criar script que valida se as tabelas foram criadas conforme esperado
   - Comparar estrutura real do banco com defini√ß√£o das migrations
   - Alertar sobre inconsist√™ncias

### A√ß√µes Futuras

- [ ] Executar plano de testes completo (docs/testes/plano-testes-feat-008.md)
- [ ] Criar teste de disciplina (similar ao test.js de curso)
- [ ] Adicionar se√ß√£o de troubleshooting no README (opcional)
- [ ] Ap√≥s aprova√ß√£o dos testes: commit, push e merge para develop

### Features Relacionadas para Revisar

- [feat-009] Criar migration para course_disciplines - Aguardando feat-008 completa
- Nenhuma feature existente precisa de revis√£o

---

## 10. NOTAS ADICIONAIS

### Decis√µes T√©cnicas

**Por que rollback em vez de ALTER TABLE?**

Embora fosse poss√≠vel usar `ALTER TABLE` para renomear as colunas (`RENAME COLUMN createdAt TO created_at`), optei pelo rollback e re-execu√ß√£o das migrations pelos seguintes motivos:

1. **Garantia de consist√™ncia:** Re-executar a migration garante que TUDO (colunas, tipos, defaults, √≠ndices) seja criado exatamente como definido
2. **Seguran√ßa:** Estamos em ambiente de desenvolvimento sem dados importantes
3. **Simplicidade:** Mais simples do que criar uma nova migration de corre√ß√£o
4. **Rastreabilidade:** A migration original permanece intacta e funcional

**Aprendizado importante sobre Sequelize CLI:**

O Sequelize CLI pode executar migrations de formas diferentes dependendo de:
- Vers√£o do Sequelize e do CLI
- Configura√ß√µes do `database.js`
- Ordem de carregamento das configura√ß√µes

**Sempre verificar a estrutura real do banco ap√≥s executar migrations!**

### Diferen√ßas com a migration de users

A migration de `users` foi executada corretamente e criou as colunas em snake_case. Isso prova que:
1. A configura√ß√£o do projeto est√° correta (`underscored: true`)
2. As migrations `create-courses` e `create-disciplines` foram executadas de forma inconsistente na primeira vez
3. Provavelmente houve alguma altera√ß√£o de configura√ß√£o ou ambiente entre as execu√ß√µes

### SQL gerado na re-execu√ß√£o

```sql
CREATE TABLE IF NOT EXISTS `courses` (
  `id` INTEGER NOT NULL auto_increment,
  `name` VARCHAR(200) NOT NULL UNIQUE,
  `description` TEXT,
  `duration_semesters` INTEGER NOT NULL,
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME,
  PRIMARY KEY (`id`)
)
```

Note que as colunas est√£o claramente em snake_case: `created_at`, `updated_at`, `deleted_at`.

---

**Ajuste conclu√≠do em:** 2025-10-26 14:48
**Revisado por:** Aguardando aprova√ß√£o do desenvolvedor senior
